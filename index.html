<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tharaga</title>
  <!-- ✅ Added stylesheet link -->
  <link rel="stylesheet" href="style.css">
</head>
<body>  

<!-- ===== Verified Buyer Form (Drop-in) ===== -->
<section id="buyer-intake" style="max-width: 760px; margin: 0 auto; padding: 24px;">
  <h3 style="font-family: 'Poppins', sans-serif; font-weight: 600; text-align:center; margin-bottom: 12px;">
    Get Matched to Verified Properties
  </h3>
  <p style="text-align:center; margin:0 0 16px;">OTP-verified leads only. No spam. No brokerage.</p>

  <!-- Netlify Forms attrs -->
  <form name="buyer-intake"
        method="POST"
        data-netlify="true"
        netlify-honeypot="bot-field"
        data-netlify-recaptcha="true"
        id="buyerForm"
        style="background:#FAF5EF; border-radius:12px; padding:16px; font-family:'Poppins',sans-serif">

    <!-- Netlify Forms hidden helpers -->
    <input type="hidden" name="form-name" value="buyer-intake" />
    <p style="display:none;">
      <label>Don’t fill this out if you’re human: <input name="bot-field" /></label>
    </p>

    <!-- UTM + referrer capture -->
    <input type="hidden" name="utm_source" id="utm_source">
    <input type="hidden" name="utm_medium" id="utm_medium">
    <input type="hidden" name="utm_campaign" id="utm_campaign">
    <input type="hidden" name="referrer" id="referrer">
    <input type="hidden" name="otp_verified" id="otp_verified" value="false">

    <!-- Lead basics -->
    <div class="grid-2">
      <label style="display:block;">
        <span>Name</span>
        <input required type="text" name="name" placeholder="Your full name"
               style="width:100%; padding:10px; border-radius:8px; border:1px solid #ddd;">
      </label>

      <label style="display:block;">
        <span>Email</span>
        <input required type="email" name="email" placeholder="you@example.com"
               style="width:100%; padding:10px; border-radius:8px; border:1px solid #ddd;">
      </label>
    </div>

    <!-- Phone + OTP -->
    <div class="grid-2 grid-right-btn">
      <label style="display:block;">
        <span>Phone (India)</span>
        <input required type="tel" name="phone" id="phone"
               pattern="^[6-9]\\d{9}$"
               placeholder="10-digit mobile number"
               style="width:100%; padding:10px; border-radius:8px; border:1px solid #ddd;">
      </label>

      <style>
        .otp-input {
          width: 40px;
          height: 50px;
          font-size: 20px;
          text-align: center;
          border: 2px solid #ccc;
          border-radius: 8px;
        }
        .otp-input:focus {
          border-color: #0e0e0e;
          outline: none;
        }
      </style>


      <button type="button" id="sendOtpBtn"
              style="padding:10px; border:none; border-radius:8px; background:#0e0e0e; color:#fff; cursor:pointer;">
        Send OTP
      </button>
    </div>

    <div id="otpBlock" style="display:none; margin-top:12px; text-align:center;">
      <div class="otp-container" style="display:flex; gap:8px; justify-content:center; margin-bottom:12px;">
        <input type="text" maxlength="1" class="otp-input" inputmode="numeric" pattern="[0-9]*" aria-label="OTP digit 1">
        <input type="text" maxlength="1" class="otp-input" inputmode="numeric" pattern="[0-9]*" aria-label="OTP digit 2">
        <input type="text" maxlength="1" class="otp-input" inputmode="numeric" pattern="[0-9]*" aria-label="OTP digit 3">
        <input type="text" maxlength="1" class="otp-input" inputmode="numeric" pattern="[0-9]*" aria-label="OTP digit 4">
        <input type="text" maxlength="1" class="otp-input" inputmode="numeric" pattern="[0-9]*" aria-label="OTP digit 5">
        <input type="text" maxlength="1" class="otp-input" inputmode="numeric" pattern="[0-9]*" aria-label="OTP digit 6">
      </div>
      <button type="button" id="verifyOtpBtn"
              style="padding:10px 20px; border:none; border-radius:8px; background:#0e0e0e; color:#fff; cursor:pointer;">
        Verify OTP
      </button>
      <small id="otpStatus" style="display:block; margin-top:6px;"></small>
    </div>

    <!-- Buyer profiling -->
    <div class="grid-2">
      <label style="display:block;">
        <span>Preferred City / Area</span>
        <input required type="text" name="location" placeholder="e.g., Anna Nagar, OMR, Coimbatore"
               style="width:100%; padding:10px; border-radius:8px; border:1px solid #ddd;">
      </label>

      <label style="display:block;">
        <span>Budget</span>
        <select required name="budget"
                style="width:100%; padding:10px; border-radius:8px; border:1px solid #ddd;">
          <option value="">Select</option>
          <option>₹50L – ₹1Cr</option>
          <option>₹1Cr – ₹2Cr</option>
          <option>₹2Cr – ₹3Cr</option>
          <option>₹3Cr+</option>
        </select>
      </label>
    </div>

    <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-top:12px;">
      <label style="display:block;">
        <span>Property Type</span>
        <select required name="property_type"
                style="width:100%; padding:10px; border-radius:8px; border:1px solid #ddd;">
          <option value="">Select</option>
          <option>Apartment</option>
          <option>Villa</option>
          <option>Plot</option>
          <option>Commercial</option>
        </select>
      </label>

      <label style="display:block;">
        <span>Buying Timeline</span>
        <select required name="timeline"
                style="width:100%; padding:10px; border-radius:8px; border:1px solid #ddd;">
          <option value="">Select</option>
          <option>ASAP (0–30 days)</option>
          <option>1–3 months</option>
          <option>3–6 months</option>
          <option>Just researching</option>
        </select>
      </label>
    </div>

    <label style="display:block; margin-top:12px;">
      <span>Financing</span>
      <select required name="financing"
              style="width:100%; padding:10px; border-radius:8px; border:1px solid #ddd;">
        <option value="">Select</option>
        <option>Loan pre-approved</option>
        <option>Loan required</option>
        <option>Self-funded</option>
      </select>
    </label>

    <label style="display:block; margin-top:12px;">
      <span>Anything else?</span>
      <textarea name="notes" rows="3" placeholder="Bedrooms, amenities, exact localities..."
                style="width:100%; padding:10px; border-radius:8px; border:1px solid #ddd;"></textarea>
    </label>

    <!-- Your existing Google reCAPTCHA v2/v3 widget works with Netlify Forms -->
    <div data-netlify-recaptcha="true" style="margin-top:12px;"></div>

    <button id="submitBtn" type="submit" disabled
            style="margin-top:14px; width:100%; padding:12px; border:none; border-radius:10px; background:#0e0e0e; color:#fff; font-weight:600; cursor:not-allowed;">
      Get My Property Matches
    </button>

    <small style="display:block; margin-top:8px; opacity:0.8;">
      By submitting, you agree to be contacted by Tharaga. OTP verification is required to prevent spam.
    </small>
  </form>

  <!-- Firebase reCAPTCHA mount (invisible) -->
  <div id="otp-recaptcha" style="height:0;"></div>
</section>

<!-- ===== Firebase + OTP Script (place before </body>) ===== -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
  import { getAuth, RecaptchaVerifier, signInWithPhoneNumber } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAlSVZK3TRIIA3GyGO8ilA1koMGdx4ZVIQ",
    authDomain: "tharaga-otp.firebaseapp.com",
    projectId: "tharaga-otp",
    appId: "1:284384574672:web:5cf14ffb80a995dfe172d5"
  };
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);

  // UTM + referrer capture
  const params = new URLSearchParams(window.location.search);
  document.getElementById('utm_source').value = params.get('utm_source') || '';
  document.getElementById('utm_medium').value = params.get('utm_medium') || '';
  document.getElementById('utm_campaign').value = params.get('utm_campaign') || '';
  document.getElementById('referrer').value = document.referrer || '';

  // Elements
  const phoneInput = document.getElementById('phone');
  const sendOtpBtn = document.getElementById('sendOtpBtn');
  const otpBlock = document.getElementById('otpBlock');
  const verifyOtpBtn = document.getElementById('verifyOtpBtn');
  const otpStatus = document.getElementById('otpStatus');
  const submitBtn = document.getElementById('submitBtn');
  const otpVerifiedField = document.getElementById('otp_verified');
  const otpInputs = document.querySelectorAll('.otp-input');

  // reCAPTCHA
  let appVerifier;
  function setupRecaptcha() {
    if (appVerifier) return; // prevent double init
    appVerifier = new RecaptchaVerifier('otp-recaptcha', { size: 'invisible' }, auth);
  }
  setupRecaptcha();

  // OTP input helpers
  function getEnteredOTP() {
    return Array.from(otpInputs).map(i => i.value).join('');
  }

  otpInputs.forEach((input, i) => {
    input.addEventListener('input', () => {
      input.value = input.value.replace(/\D/g, '').slice(0, 1);
      if (input.value && i < otpInputs.length - 1) otpInputs[i + 1].focus();
    });
    input.addEventListener('keydown', (e) => {
      if (e.key === 'Backspace' && !input.value && i > 0) otpInputs[i - 1].focus();
      if (e.key === 'ArrowLeft' && i > 0) otpInputs[i - 1].focus();
      if (e.key === 'ArrowRight' && i < otpInputs.length - 1) otpInputs[i + 1].focus();
    });
  });

  // Paste full code
  otpInputs[0].addEventListener('paste', (e) => {
    const text = (e.clipboardData || window.clipboardData).getData('text').replace(/\D/g,'').slice(0,6);
    text.split('').forEach((d, idx) => { if (otpInputs[idx]) otpInputs[idx].value = d; });
    e.preventDefault();
    if (text.length === 6) otpInputs[5].focus();
  });

  let confirmationResult = null;

  sendOtpBtn.addEventListener('click', async () => {
    const raw = phoneInput.value.trim();
    if (!/^[6-9]\d{9}$/.test(raw)) {
      alert('Enter a valid 10-digit Indian mobile number.');
      return;
    }

    // Show the OTP block immediately so users always see the boxes
    otpBlock.style.display = 'block';
    otpStatus.textContent = 'Sending OTP…';

    try {
      sendOtpBtn.disabled = true;
      const e164 = '+91' + raw;
      confirmationResult = await signInWithPhoneNumber(auth, e164, appVerifier);
      otpStatus.textContent = 'OTP sent. Please check your SMS.';
    } catch (err) {
      console.error(err);
      otpStatus.textContent = 'Could not send OTP. Please try again.';
      sendOtpBtn.disabled = false;
      // re-init captcha for next try
      appVerifier = null;
      setupRecaptcha();
    }
  });

  verifyOtpBtn.addEventListener('click', async () => {
    try {
      const code = getEnteredOTP();
      if (code.length !== 6) {
        otpStatus.textContent = 'Please enter all 6 digits.';
        return;
      }
      await confirmationResult.confirm(code);
      otpStatus.textContent = 'Verified ✅';
      otpVerifiedField.value = 'true';
      submitBtn.disabled = false;
      submitBtn.style.cursor = 'pointer';
    } catch (err) {
      console.error(err);
      otpStatus.textContent = 'Invalid OTP. Please try again.';
    }
  });

  // Block submit if OTP not verified
  document.getElementById('buyerForm').addEventListener('submit', (e) => {
    if (otpVerifiedField.value !== 'true') {
      e.preventDefault();
      alert('Please verify OTP before submitting.');
    }
  });
</script>

