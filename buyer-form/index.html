<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tharaga Buyer Match</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>

<section id="buyer-intake">
  <h3>Get Matched to Verified Properties</h3>
  <p>OTP-verified leads only. No spam. No brokerage.</p>

  <form name="buyer-intake" method="POST" data-netlify="true" netlify-honeypot="bot-field" id="buyerForm">

    <input type="hidden" name="form-name" value="buyer-intake">
    <p style="display:none;"><label>Don’t fill if human: <input name="bot-field"></label></p>

    <input type="hidden" name="utm_source" id="utm_source">
    <input type="hidden" name="utm_medium" id="utm_medium">
    <input type="hidden" name="utm_campaign" id="utm_campaign">
    <input type="hidden" name="referrer" id="referrer">
    <input type="hidden" name="otp_verified" id="otp_verified" value="false">

    <div class="grid-2">
      <label>Name<input required type="text" name="name" placeholder="Full Name"></label>
      <label>Email<input required type="email" name="email" placeholder="you@example.com"></label>
    </div>

    <div class="grid-2 grid-right-btn">
      <label>Phone (India)<input required type="tel" id="phone" name="phone" pattern="^[6-9]\d{9}$" placeholder="10-digit mobile"></label>
      <button type="button" id="sendOtpBtn">Send OTP</button>
    </div>

    <div id="otpBlock" style="display:none;">
      <div class="otp-container">
        <input type="text" maxlength="1" class="otp-input">
        <input type="text" maxlength="1" class="otp-input">
        <input type="text" maxlength="1" class="otp-input">
        <input type="text" maxlength="1" class="otp-input">
        <input type="text" maxlength="1" class="otp-input">
        <input type="text" maxlength="1" class="otp-input">
      </div>
      <button type="button" id="verifyOtpBtn">Verify OTP</button>
      <small id="otpStatus"></small>
    </div>

    <div class="grid-2">
      <label>Preferred City/Area<input required type="text" name="location"></label>
      <label>Budget<select required name="budget">
        <option value="">Select</option>
        <option>₹50L – ₹1Cr</option>
        <option>₹1Cr – ₹2Cr</option>
        <option>₹2Cr – ₹3Cr</option>
        <option>₹3Cr+</option>
      </select></label>
    </div>

    <div class="grid-2">
      <label>Property Type<select required name="property_type">
        <option value="">Select</option>
        <option>Apartment</option>
        <option>Villa</option>
        <option>Plot</option>
        <option>Commercial</option>
      </select></label>
      <label>Buying Timeline<select required name="timeline">
        <option value="">Select</option>
        <option>ASAP (0–30 days)</option>
        <option>1–3 months</option>
        <option>3–6 months</option>
        <option>Just researching</option>
      </select></label>
    </div>

    <label>Financing<select required name="financing">
      <option value="">Select</option>
      <option>Loan pre-approved</option>
      <option>Loan required</option>
      <option>Self-funded</option>
    </select></label>

    <label>Anything else?<textarea name="notes" rows="3"></textarea></label>

    <button id="submitBtn" type="submit" disabled>Get My Property Matches</button>
  </form>

  <div id="otp-recaptcha"></div>
</section>

<div id="aiMatches"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
import { getAuth, RecaptchaVerifier, signInWithPhoneNumber } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyAUNl5bZif51a8b5FC5kKqZs40KlP5lP74",
  authDomain: "tharaga-n.firebaseapp.com",
  projectId: "tharaga-n",
  appId: "1:122537471507:web:346c29119a352cc87059e6"
};
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
auth.languageCode='en';

// UTM + referrer
const params=new URLSearchParams(window.location.search);
document.getElementById('utm_source').value=params.get('utm_source')||'';
document.getElementById('utm_medium').value=params.get('utm_medium')||'';
document.getElementById('utm_campaign').value=params.get('utm_campaign')||'';
document.getElementById('referrer').value=document.referrer||'';

const form=document.getElementById('buyerForm');
const phoneInput=document.getElementById('phone');
const sendOtpBtn=document.getElementById('sendOtpBtn');
const otpBlock=document.getElementById('otpBlock');
const verifyOtpBtn=document.getElementById('verifyOtpBtn');
const otpStatus=document.getElementById('otpStatus');
const submitBtn=document.getElementById('submitBtn');
const otpVerifiedField=document.getElementById('otp_verified');
const otpInputs=document.querySelectorAll('.otp-input');

let confirmationResult=null;

// reCAPTCHA
function initRecaptcha(){
  if(window.recaptchaVerifier) return;
  window.recaptchaVerifier=new RecaptchaVerifier('otp-recaptcha',{size:'invisible'},auth);
  window.recaptchaVerifier.render();
}
initRecaptcha();

// OTP input behavior
function getEnteredOTP(){ return Array.from(otpInputs).map(i=>i.value).join(''); }
otpInputs.forEach((input,i)=>{
  input.addEventListener('input',()=>{ input.value=input.value.replace(/\D/g,'').slice(0,1); if(input.value && i<otpInputs.length-1) otpInputs[i+1].focus(); });
  input.addEventListener('keydown',e=>{
    if(e.key==='Backspace' && !input.value && i>0) otpInputs[i-1].focus();
    if(e.key==='ArrowLeft' && i>0) otpInputs[i-1].focus();
    if(e.key==='ArrowRight' && i<otpInputs.length-1) otpInputs[i+1].focus();
  });
});
otpInputs[0].addEventListener('paste',e=>{
  const text=(e.clipboardData||window.clipboardData).getData('text').replace(/\D/g,'').slice(0,6);
  text.split('').forEach((d,idx)=>{ if(otpInputs[idx]) otpInputs[idx].value=d; });
  e.preventDefault(); if(text.length===6) otpInputs[5].focus();
});

// Send OTP
sendOtpBtn.addEventListener('click',async ()=>{
  const raw=phoneInput.value.trim();
  if(!/^[6-9]\d{9}$/.test(raw)){ alert('Enter valid 10-digit mobile'); return; }
  otpBlock.style.display='block'; otpStatus.textContent='Sending OTP…'; sendOtpBtn.disabled=true;
  try{
    initRecaptcha();
    confirmationResult=await signInWithPhoneNumber(auth,'+91'+raw,window.recaptchaVerifier);
    otpStatus.textContent='OTP sent';
  }catch(err){ console.error(err); otpStatus.textContent='Could not send OTP'; }
  finally{ sendOtpBtn.disabled=false; }
});

// Verify OTP
verifyOtpBtn.addEventListener('click',async ()=>{
  try{
    const code=getEnteredOTP();
    if(code.length!==6){ otpStatus.textContent='Enter all 6 digits'; return; }
    await confirmationResult.confirm(code);
    otpStatus.textContent='Verified ✅'; otpVerifiedField.value='true'; submitBtn.disabled=false; submitBtn.style.cursor='pointer';
  }catch(err){ console.error(err); otpStatus.textContent='Invalid OTP'; }
});

// Submit form
form.addEventListener('submit',async e=>{
  e.preventDefault();
  if(otpVerifiedField.value!=='true'){ alert('Verify OTP first'); return; }
  submitBtn.disabled=true; submitBtn.textContent='Processing...';
  const formData={
    name: form.name.value, email: form.email.value, phone: form.phone.value,
    location: form.location.value, budget: form.budget.value, property_type: form.property_type.value,
    timeline: form.timeline.value, financing: form.financing.value, notes: form.notes.value,
    utm_source: form.utm_source.value, utm_medium: form.utm_medium.value,
    utm_campaign: form.utm_campaign.value, referrer: form.referrer.value,
    otp_verified: otpVerifiedField.value
  };
  try{
    const res=await fetch("/.netlify/functions/buyerMatch",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(formData)});
    const result=await res.json();
    if(res.ok){ showPropertyMatches(result.matches); }
    else{ alert(result.error||'Something went wrong'); }
  }catch(err){ console.error(err); alert('Submission failed'); }
  finally{ submitBtn.disabled=false; submitBtn.textContent='Get My Property Matches'; }
});

function showPropertyMatches(matches){
  let container=document.getElementById('aiMatches');
  if(!container){
    container=document.createElement('div'); container.id='aiMatches';
    form.parentNode.appendChild(container);
  }
  container.innerHTML="<h4>Your AI Matched Properties</h4>";
  if(!matches || matches.length===0){ container.innerHTML+="<p>No matches found yet.</p>"; return; }
  matches.forEach(p=>{
    const card=document.createElement('div');
    card.innerHTML=`<h5>${p.name||'Property'}</h5>
      <p>${p.location||''} | ${p.bhk||''} BHK | ${p.carpet_area||''} sqft</p>
      <p>Price: ${p.price||'-'}</p>
      <a href="${p.url||'#'}" target="_blank">View Property</a>`;
    container.appendChild(card);
  });
}
</script>

</body>
</html>
